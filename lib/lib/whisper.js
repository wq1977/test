var _models=require('./models');var _effects=require('redux-saga/effects');var _marked=regeneratorRuntime.mark(subscribe),_marked2=regeneratorRuntime.mark(post),_marked3=regeneratorRuntime.mark(whisperSaga);var utils=require('ethers').utils;var shh=void 0;String.prototype.hash=function(){var md5=require('md5');return'0x'+md5(this).substr(0,8);};function subscribe(action){var _loop,_iterator,_isArray,_i,_ref,room;return regeneratorRuntime.wrap(function subscribe$(_context){while(1){switch(_context.prev=_context.next){case 0:_loop=function _loop(room){shh.addSymKey(room.key,function(err,keyid){_models.store.dispatch({type:'room keyid',payload:{room:room,keyid:keyid}});shh.subscribe('messages',{symKeyID:keyid,topics:[room.title.hash()]},function(err,msg){_models.store.dispatch({type:'new message',payload:{msg:msg}});});});};_iterator=action.payload,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==='function'?typeof Symbol==='function'?Symbol.iterator:'@@iterator':'@@iterator']();case 2:if(!_isArray){_context.next=8;break;}if(!(_i>=_iterator.length)){_context.next=5;break;}return _context.abrupt('break',16);case 5:_ref=_iterator[_i++];_context.next=12;break;case 8:_i=_iterator.next();if(!_i.done){_context.next=11;break;}return _context.abrupt('break',16);case 11:_ref=_i.value;case 12:room=_ref;_loop(room);case 14:_context.next=2;break;case 16:_context.next=18;return 0;case 18:case'end':return _context.stop();}}},_marked,this);}function post(action){var whisper;return regeneratorRuntime.wrap(function post$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return(0,_effects.select)(function(state){return state.whisper;});case 2:whisper=_context2.sent;shh.post({symKeyID:action.payload.room.item.keyid,ttl:10,sig:whisper.id,topic:action.payload.room.item.title.hash(),payload:utils.hexlify(utils.toUtf8Bytes(action.payload.cnt)),powTime:3,powTarget:0.5});_context2.next=6;return 0;case 6:case'end':return _context2.stop();}}},_marked2,this);}function whisperSaga(){var Shh;return regeneratorRuntime.wrap(function whisperSaga$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:Shh=require('web3-shh');shh=new Shh('ws://52.221.202.146:8546');_context3.next=4;return(0,_effects.takeEvery)('chatrooms',subscribe);case 4:_context3.next=6;return(0,_effects.takeEvery)('whisper',post);case 6:_models.store.dispatch({type:'chatrooms',payload:[{key:'0x4584c683952ebd019cb339875cb3e68102e3b490d1704b1a251ea50fc7cb9395',title:'乌镇灌水区'},{key:'0x22f1f82850b6cea23ce113bad91de9cab44af25ab82e6079b96a8af03894da48',title:'场外交易区'},{key:'0xe45921c7a920f4a907db67e5352107edeea39f3d769f6fa34e850798088c15cc',title:'跳蚤市场区'}]});shh.newKeyPair().then(function(id){shh.getPublicKey(id,function(err,pubkey){_models.store.dispatch({type:'save',payload:{whisper:{id:id,pubkey:pubkey}}});});});case 8:case'end':return _context3.stop();}}},_marked3,this);}_models.saga.run(whisperSaga);